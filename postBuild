#!/bin/bash

set -ex

export LD_LIBRARY_PATH=/srv/conda/envs/notebook/lib:$LD_LIBRARY_PATH

# conda only provides java 8, and ubuntu java 11 is broken, so manually install java 15...
mkdir .java
cd .java

wget https://download.java.net/java/GA/jdk15.0.2/0d1cfde4252546c6931946de8db48ee2/7/GPL/openjdk-15.0.2_linux-x64_bin.tar.gz

tar xzvf openjdk-15.0.2_linux-x64_bin.tar.gz
# save some space on the image
rm openjdk-15.0.2_linux-x64_bin.tar.gz

cd ..

JAVA_HOME=`pwd`/.java/jdk-15.0.2 R CMD javareconf

# install JDX (not on conda-forge)
R --no-save <<EOF
install.packages('jdx', repos='https://cloud.r-project.org/')
EOF

# install the R package from local source
R CMD INSTALL r-package